<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Battery Finder – Wix Embed (Upload Only)</title>
<style>
:root{
  --brand-primary:#0ea5e9;
  --brand-text:#0f172a;
  --brand-muted:#64748b;
  --surface:#ffffff;
  --surface-2:#f8fafc;
  --ring:#38bdf8;
}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;background:var(--surface-2);color:var(--brand-text)}
.container{max-width:1100px;margin:16px auto;padding:0 12px}
.header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.logo{height:28px;width:28px;border-radius:6px;object-fit:contain;display:none}
.title{font-weight:700;font-size:18px;color:var(--brand-primary)}
.card{background:var(--surface);border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:12px;margin:10px 0}
.row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;align-items:center}
.small{font-size:12px;color:var(--brand-muted)} .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.input, select{width:100%;border:1px solid #d1d5db;border-radius:12px;padding:8px 10px;outline:none}
.input:focus, select:focus{border-color:var(--ring);box-shadow:0 0 0 2px rgba(56,189,248,.3)}
.btn{display:inline-flex;align-items:center;gap:6px;border:1px solid #cbd5e1;border-radius:12px;background:#fff;padding:8px 12px;cursor:pointer}
.res-card{border:1px solid #e5e7eb;border-radius:12px;padding:12px;background:#fff}
.grid{display:grid;gap:10px}
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<div class="container">
  <div class="header">
    <img id="logo" class="logo" alt="logo" />
    <div class="title">Battery Finder</div>
    <div class="small" style="margin-left:auto">Upload a CSV exported from <span class="mono">sample_au_passenger</span>. No live loading.</div>
  </div>

  <div class="card">
    <div class="row">
      <div style="grid-column: span 8">
        <div class="small" style="margin-bottom:6px">Upload CSV</div>
        <input id="file" type="file" accept=".csv,text/csv" class="input"/>
      </div>
      <div style="grid-column: span 4; display:flex; align-items:end; justify-content:flex-end">
        <button id="export" class="btn">Export current results</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div style="grid-column: span 2">
        <div class="small" style="margin-bottom:6px">Make</div>
        <select id="make"></select>
      </div>
      <div style="grid-column: span 2">
        <div class="small" style="margin-bottom:6px">Model</div>
        <select id="model"></select>
      </div>
      <div style="grid-column: span 2">
        <div class="small" style="margin-bottom:6px">Series</div>
        <select id="series"></select>
      </div>
      <div style="grid-column: span 2">
        <div class="small" style="margin-bottom:6px">Year</div>
        <select id="year"></select>
      </div>
      <div style="grid-column: span 2">
        <div class="small" style="margin-bottom:6px">Engine/Trim</div>
        <select id="engine"></select>
      </div>
      <div style="grid-column: span 2">
        <div class="small" style="margin-bottom:6px">Filter</div>
        <input id="q" class="input" placeholder="series / chassis / notes"/>
      </div>
    </div>
  </div>

  <div id="meta" class="small" style="margin:6px 0 4px"></div>
  <div id="results" class="grid"></div>
</div>

<script>
const REQUIRED = ["Make","Model","Series","Chassis/Gen","Year_From","Year_To","Engine/Trim","Fuel","StopStart","Neuton_Code","Polarity/Layout","Terminal_Type","Confidence","Verify_Flag","Verify_Notes","Notes"];
let ROWS = [];
const $ = (id)=>document.getElementById(id);

function norm(s){ return (s||"").toString().trim(); }
function unique(a){ return Array.from(new Set(a)); }

function setOpts(sel, opts){
  const v = sel.value;
  sel.innerHTML = "<option value=''>All</option>"+opts.map(o=>`<option value=\"${o}\">${o}</option>`).join("");
  if(unique(opts).includes(v)) sel.value = v;
}

function renderSelectors(){
  const makeSel = $("make"), modelSel=$("model"), seriesSel=$("series"), yearSel=$("year"), engineSel=$("engine");
  const make = makeSel.value, model = modelSel.value, series = seriesSel.value;

  setOpts(makeSel, unique(ROWS.map(r=>r.Make)).sort());
  setOpts(modelSel, unique(ROWS.filter(r=>!make||r.Make===make).map(r=>r.Model)).sort());
  setOpts(seriesSel, unique(ROWS.filter(r=>(!make||r.Make===make)&&(!model||r.Model===model)).map(r=>r.Series)).sort());

  const years = new Set();
  ROWS.filter(r=>(!make||r.Make===make)&&(!model||r.Model===model)&&(!series||r.Series===series)).forEach(r=>{
    const y1 = parseInt(r.Year_From,10), y2=parseInt(r.Year_To,10);
    if(!isNaN(y1)&&!isNaN(y2)){ for(let y=y1;y<=y2;y++) years.add(String(y)); }
  });
  setOpts(yearSel, Array.from(years).sort((a,b)=>a-b));

  setOpts(engineSel, unique(ROWS.filter(r=>(!make||r.Make===make)&&(!model||r.Model===model)&&(!series||r.Series===series)).map(r=>r["Engine/Trim"]).filter(Boolean)).sort());
}

function filtered(){
  const make = $("make").value, model=$("model").value, series=$("series").value, year=$("year").value, engine=$("engine").value, q=$("q").value.toLowerCase();
  let out = ROWS;
  if(make) out = out.filter(r=>r.Make===make);
  if(model) out = out.filter(r=>r.Model===model);
  if(series) out = out.filter(r=>r.Series===series);
  if(year){
    const yr = parseInt(year,10);
    out = out.filter(r=>{
      const y1=parseInt(r.Year_From,10), y2=parseInt(r.Year_To,10);
      if(isNaN(y1)||isNaN(y2)||isNaN(yr)) return true;
      return yr>=y1 && yr<=y2;
    });
  }
  if(engine) out = out.filter(r=>r["Engine/Trim"]===engine);
  if(q){
    out = out.filter(r=>[r.Make,r.Model,r.Series,r["Chassis/Gen"]||"",r["Engine/Trim"],r.Notes||"",r["Verify_Notes"]||""].join("␟").toLowerCase().includes(q));
  }
  return out;
}

function render(){
  const out = filtered();
  $("meta").textContent = `Showing ${out.length} matches`;
  const host = $("results"); host.innerHTML = "";
  out.slice(0,100).forEach(r=>{
    const card = document.createElement('div'); card.className = 'res-card';
    card.innerHTML = `
      <div class="row">
        <div style="grid-column: span 4"><strong>${r.Make} ${r.Model}</strong><div class="small">${r.Series}${r["Chassis/Gen"]? " • "+r["Chassis/Gen"]:""}</div></div>
        <div style="grid-column: span 3">${r.Year_From}–${r.Year_To}<div class="small">${r["Engine/Trim"]} • ${r.Fuel||""}</div></div>
        <div style="grid-column: span 3"><div class="small">Neuton Part</div><div class="mono">${r.Neuton_Code||"—"}</div></div>
        <div style="grid-column: span 2" class="small">${r["Polarity/Layout"]||""}${r["Terminal_Type"]? " • "+r["Terminal_Type"]:""}<div>ISS: ${r.StopStart||""} • Conf: ${r.Confidence||""}</div></div>
      </div>`;
    host.appendChild(card);
  });
}

function csvExport(rows){
  const csv = Papa.unparse(rows);
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "battery-finder-export.csv"; a.click();
  URL.revokeObjectURL(url);
}

$("export").addEventListener("click", ()=> csvExport(filtered()));

$("file").addEventListener("change", (e)=>{
  const file = e.target.files && e.target.files[0];
  if(!file) return;
  Papa.parse(file, {
    header:true, skipEmptyLines:true, transformHeader: h=>h.trim(),
    complete: (res)=>{
      const fields = res.meta.fields||[];
      const missing = ["Make","Model","Series","Chassis/Gen","Year_From","Year_To","Engine/Trim","Fuel","StopStart","Neuton_Code","Polarity/Layout","Terminal_Type","Confidence","Verify_Flag","Verify_Notes","Notes"].filter(c=>!fields.includes(c));
      if(missing.length){ alert("Missing required columns: "+missing.join(", ")); return; }
      const data = (res.data||[]).map(r=>{
        const c = {...r};
        c["Year_From"] = (norm(c["Year_From"]).match(/\\d{4}/)||[])[0] || c["Year_From"];
        c["Year_To"] = norm(c["Year_To"]).replace(/^on$/i,"2025");
        c["Year_To"] = (norm(c["Year_To"]).match(/\\d{4}/)||[])[0] || c["Year_To"];
        return c;
      });
      ROWS = data;
      ["make","model","series","year","engine","q"].forEach(id=>$(id).value="");
      renderSelectors(); render();
    },
    error: (err)=> alert("CSV parse error: "+err.message),
  });
});
</script>
</body>
</html>
